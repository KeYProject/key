
\predicates {
    /* use this as input */
    traceAfter(int, java.lang.String);
    traceBefore(int, java.lang.String);

    /* used this to display current trace string */
    traced(int, int, Seq);

    /* used on the sequent */
    traceIf(int);
}

\functions {
    /* helper function without meaning */
    Seq seqConcatEnd(Seq, Seq);
}

\schemaVariables {
    \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
    \program SimpleExpression #se;
    \program Statement #s0, #s1, #s2;
    \formula post;
    \term int idx, idx0;
    \term java.lang.String str;
    \term Seq #seq;
}

\rules(programRules:Java) {

    /*
     * Initialization (TODO: disable this by default?)
     */
    //traceIndexInit {
    //   \add( tracer.Trace.index = 0, traced(0, 0, "") ==> )
    //   \heuristics(simplify)
    //};


    /*
     * Symbolic execution rules, using (!) traceIf(int)
     */
    traceIf {
        \find(
            ==> \modality{#allmodal}{..
                if(#se) #s0
            ...}\endmodality (post)
        )
        \replacewith(
            ==>
            \if(traceIf(tracer.Trace.index))
            \then(
                {tracer.Trace.index := tracer.Trace.index+1}\modality{#allmodal}{..
                    #s0
                ...}\endmodality (post)
            )
            \else(
                {tracer.Trace.index := tracer.Trace.index+1}\modality{#allmodal}{..
                ...}\endmodality (post)
            )
        )
        \add(
            (#se = TRUE) <-> traceIf(tracer.Trace.index)
            ==>
        )
        \heuristics(retrace)
    };

    traceIfElse {
        \find(
            ==> \modality{#allmodal}{..
                if(#se) #s0 else #s1
            ...}\endmodality (post)
        )
        \replacewith(
            ==>
            \if(traceIf(tracer.Trace.index))
            \then(
                {tracer.Trace.index := tracer.Trace.index+1}\modality{#allmodal}{..
                    #s0
                ...}\endmodality (post)
            )
            \else(
                {tracer.Trace.index := tracer.Trace.index+1}\modality{#allmodal}{..
                    #s1
                ...}\endmodality (post)
            )
        )
        \add(
            (#se = TRUE) <-> traceIf(tracer.Trace.index)
            ==>
        )
        \heuristics(retrace)
    };

    /*
     * Rules to convert string traces to sets of traceIf(int) in sequent
     */
    traceFollowElse {
      \find(
          traceAfter(idx, strPool(seqConcat(seqSingleton('0'), #seq)))
      )
      \replacewith(
          !traceIf(idx) & traceAfter(idx + 1, strPool(#seq))
      )
      \heuristics(simplify)
    };

    traceFollowElseEnd {
      \find(
         traceAfter(idx, strPool(seqSingleton('0')))
      )
      \replacewith(
         !traceIf(idx)
      )
      \heuristics(simplify)
    };

    traceFollowIf {
      \find(
          traceAfter(idx, strPool(seqConcat(seqSingleton('1'), #seq)))
      )
      \replacewith(
          traceIf(idx) & traceAfter(idx + 1, strPool(#seq))
      )
      \heuristics(simplify)
    };

    traceFollowIfEnd {
      \find(
         traceAfter(idx, strPool(seqSingleton('1')))
      )
      \replacewith(
         traceIf(idx)
      )
      \heuristics(simplify)
    };

    traceBeforeElim {
        \find(
            traceBefore(idx, strPool(#seq))
        )
        \replacewith(
            traceAfter(idx - seqLen(#seq), strPool(#seq))
        )
        \heuristics(simplify)
    };

    /*
     * Rules to reconvert traceIf(int) sets for displaying the current trace
     */
    printTracedIf {
      \assumes(
          traceIf(idx) ==>
      )
      \find(
          traced(idx0, idx, #seq) ==>
      )
      \replacewith(
          traced(idx0, idx + 1, seqConcatEnd(#seq, seqSingleton('1'))) ==>
      )
      \heuristics(simplify)
    };

    printTracedElse {
      \assumes(
          ==> traceIf(idx)
      )
      \find(
          traced(idx0, idx, #seq) ==>
      )
      \replacewith(
          traced(idx0, idx + 1, seqConcatEnd(#seq, seqSingleton('0'))) ==>
      )
      \heuristics(simplify)
    };

    seqConcatEndNormalize {
       \schemaVar \term Seq slit1, slit2;
       \schemaVar \term int v;
       \find (seqConcatEnd(seqConcat(slit1, slit2),seqSingleton(v)))
       \replacewith( seqConcat(slit1,seqConcatEnd(slit2,seqSingleton(v))))
       \heuristics(simplify)
    };

    seqConcatEndNormalize2 {
       \schemaVar \term int v;
       \find (seqConcatEnd(seqEmpty,seqSingleton(v)))
       \replacewith( seqSingleton(v))
       \heuristics(simplify)
    };

    seqConcatEndNormalize3 {
       \schemaVar \term int v1, v2;
       \find (seqConcatEnd(seqSingleton(v1),seqSingleton(v2)))
       \replacewith(seqConcat(seqSingleton(v1),seqSingleton(v2)))
       \heuristics(simplify)
    };
}
