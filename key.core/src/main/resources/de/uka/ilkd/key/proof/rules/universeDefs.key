\rules(programRules:Java) {
    // ---------------------------------------------------
    //   Introduction Rules
    // ---------------------------------------------------
    variableDeclarationPayload {
        \schemaVar \formula post;
        \schemaVar \program Variable #v0;
        \schemaVar \program Type #t0;
        \schemaVar \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
        \schemaVar \program ProgramMethod #pm;

        \find(\modality{#allmodal}{.. @universe.qual.Payload #t0 #v0; ...}\endmodality (post))
        \sameUpdateLevel

        \replacewith(\modality{#allmodal}{..  ...}\endmodality (post))
        \addprogvars(#v0)

        \heuristics(simplify_prog, simplify_prog_subset)
        //\displayname "variableDeclaration"
    };

    variableDeclarationPayloadAssign {
        \schemaVar \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
        \schemaVar \formula post;
        \schemaVar \program Variable #v0;
        \schemaVar \program Type #t;
        \schemaVar \program VariableInitializer #vi;
   
        \find(\modality{#allmodal}{.. @universe.qual.Payload #t #v0 = #vi; ...}\endmodality (post))
        \replacewith(\modality{#allmodal}{.. @universe.qual.Payload #t #v0; #v0 = #vi; ...}\endmodality (post))
   
        \heuristics(simplify_prog, simplify_prog_subset)
        \displayname "variableDeclaration"
    };

    variableDeclarationPeer {
        \schemaVar \formula post;
        \schemaVar \program Variable #v, #v0;
        \schemaVar \program Type #t, #t0;
        \schemaVar \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
        \schemaVar \program ProgramMethod #pm;

        \find(\modality{#allmodal}{.#pm@#t(#v).. @universe.qual.Peer #t0 #v0; ...}\endmodality (post))
        \sameUpdateLevel

        \replacewith(\modality{#allmodal}{..  ...}\endmodality (post))
        \addprogvars(#v0)

        \heuristics(simplify_prog, simplify_prog_subset)
        //\displayname "variableDeclaration"
    };

    variableDeclarationPeerAssign {
        \schemaVar \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
        \schemaVar \formula post;
        \schemaVar \program Variable #v0;
        \schemaVar \program Type #t;
        \schemaVar \program VariableInitializer #vi;
   
        \find(\modality{#allmodal}{.. @universe.qual.Peer #t #v0 = #vi; ...}\endmodality (post))
        \replacewith(\modality{#allmodal}{.. @universe.qual.Peer #t #v0; #v0 = #vi; ...}\endmodality (post))
   
        \heuristics(simplify_prog, simplify_prog_subset)
        \displayname "variableDeclaration"
    };

    variableDeclarationRep {
        \schemaVar \formula post;
        \schemaVar \program Variable #v, #v0;
        \schemaVar \program Type #t, #t0;
        \schemaVar \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
        \schemaVar \program ProgramMethod #pm;

        \find(\modality{#allmodal}{.#pm@#t(#v).. @universe.qual.Rep #t0 #v0; ...}\endmodality (post))

        \sameUpdateLevel
        \replacewith(\modality{#allmodal}{..  ...}\endmodality (post))
        \addprogvars(#v0)

        \heuristics(simplify_prog, simplify_prog_subset)
        //\displayname "variableDeclaration"
    };

    variableDeclarationRepAssign {
        \schemaVar \modalOperator {diamond, box, diamond_transaction, box_transaction} #allmodal;
        \schemaVar \formula post;
        \schemaVar \program Variable #v0;
        \schemaVar \program Type #t;
        \schemaVar \program VariableInitializer #vi;
   
        \find(\modality{#allmodal}{.. @universe.qual.Rep #t #v0 = #vi; ...}\endmodality (post))
        \replacewith(\modality{#allmodal}{.. @universe.qual.Rep #t #v0; #v0 = #vi; ...}\endmodality (post))
   
        \heuristics(simplify_prog, simplify_prog_subset)
        \displayname "variableDeclaration"
    };

    instanceCreationAssignmentPeer {
        \schemaVar \modalOperator {diamond} #diamond;
        \schemaVar \modalOperator {diamond, box} #normal;
        \schemaVar \formula post;
        \schemaVar \program ProgramMethod #pm;
        \schemaVar \program Type #t;
        \schemaVar \program SimpleInstanceCreation #n;
        \schemaVar \program LeftHandSide #lhs;
        \schemaVar \program Variable #v0, #v;
    
        \find(\modality{#normal}{.#pm@#t(#v).. #lhs = #n; ...}\endmodality (post))
        \sameUpdateLevel
    
        \varcond(\newTypeOf(#v0, #lhs), \hasAnnotation(#n, Peer))
    
        \replacewith(\modality{#normal}{.. #typeof(#v0) #v0 = #create-object(#n);
                    #constructor-call(#v0, #n);
                            #post-work(#v0);
                #lhs = #v0;
                ...}\endmodality (post | !(#v0 != null -> owner(#v0) = owner(#v))))
        \heuristics(method_expand)
    };

    instanceCreationAssignmentRep {
        \schemaVar \modalOperator {diamond} #diamond;
        \schemaVar \modalOperator {diamond, box} #normal;
        \schemaVar \formula post;
        \schemaVar \program ProgramMethod #pm;
        \schemaVar \program Type #t;
        \schemaVar \program SimpleInstanceCreation #n;
        \schemaVar \program LeftHandSide #lhs;
        \schemaVar \program Variable #v0, #v;
    
        \find(\modality{#normal}{.#pm@#t(#v).. #lhs = #n; ...}\endmodality (post))
        \sameUpdateLevel
    
        \varcond(\newTypeOf(#v0, #lhs), \hasAnnotation(#n, Rep))
    
        \replacewith(\modality{#normal}{.. #typeof(#v0) #v0 = #create-object(#n);
                    #constructor-call(#v0, #n);
                            #post-work(#v0);
                #lhs = #v0;
                ...}\endmodality (post | !(#v0 != null -> owner(#v0) = #v)))
        \heuristics(method_expand)
    };

    peerField {
        \schemaVar \term Object o;
        \schemaVar \term Field f;
        \schemaVar \term Heap h;
    
        \find(alpha::select(h, o, f))
        \varcond(\hasAnnotation(f, Peer))
        \add(alpha::select(h, o, f) != null -> owner(Object::cast(o)) = owner(Object::cast(alpha::select(h, o, f))) ==>)
        \heuristics(simplify)
    };

    ownsField {
        \schemaVar \term Object o;
        \schemaVar \term Field f;
        \schemaVar \term Heap h;
    
        \find(alpha::select(h, o, f))
        \varcond(\hasAnnotation(f, Rep))
        \add(alpha::select(h, o, f) != null -> owner(Object::cast(alpha::select(h, o, f))) = o ==>)
        \heuristics(simplify)
    };

    // ---------------------------------------------------
    //    Predicate and Function definitions
    // ---------------------------------------------------

    undomDef {
        \schemaVar \term Object x, y;

        \find(undom(x, y))

        \replacewith(!dominates(x, y) & !dominates(y, x) & !(x = y))
    };

    createdRepfpDef {
        \schemaVar \term Object x;
        \schemaVar \term Heap h;
        \schemaVar \variables Object y;

        \find(createdRepfp(h, x))

        \varcond(\notFreeIn(y, x, h))

        \replacewith(intersect(infiniteUnion{y;}(\if(boolean::select(h, y, java.lang.Object::<created>) = TRUE) \then(y.*) \else(empty)), repfp(x)))

        \heuristics(classAxiom)
    };

    \lemma
    repfpDef {
        \schemaVar \term Object x;
        \schemaVar \variables Object y;

        \find(repfp(x))
        \varcond(\notFreeIn(y, x))
        \replacewith(union(x.*, infiniteUnion{y;}(\if(dominates(x, y)) \then(y.*) \else(empty))))
    };

  
    // ---------------------------------------------------
    //    axioms for ownership
    // ---------------------------------------------------

    dominatesSelf {
        \schemaVar \term Object o;

        \find(dominates(o, o))

        \replacewith(false)

        \heuristics(concrete)
    };
}
