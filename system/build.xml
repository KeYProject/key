<?xml version="1.0"?>
<project name="key" default="compile" basedir=".">

  <property environment="env" /> <!-- include environment variables -->

  <property name="src.dir"   value="${basedir}" />
  <property name="build.dir" value="${basedir}/build" />
  <property name="dist.dir"  value="${basedir}/binary" />
  <property name="gen.dir"  value="${basedir}/genSrc" />
  <property name="docs.dir"  value="${basedir}/doc"   />
  <property name="ext.dir"   value="${basedir}/../key-ext-jars"   />
  <property name="tg.dir"    value="${ext.dir}/TOGETHER"   />
  <property name="instrument.dir" value="${basedir}/instrumented/" />


  <property name="xerces.jar" value="${ext.dir}/xerces.jar" />
  <property name="nsuml.jar"  value="${tg.dir}/lib/nsuml.jar" />
  <property name="jdom.jar"   value="${tg.dir}/lib/jdom.jar" />
  <property name="junit.jar"  value="${ext.dir}/junit.jar"  />

  <property name="jcoverage.jar" value="${ext.dir}/jcoverage.jar" />

  <property file="local.properties" />

  <path id="jcoverage">
    <fileset dir="${ext.dir}">
      <include name="jcoverage.jar"/>
    </fileset>
  </path>

  <target name="info">
    <echo message="Target info is obsolete, use ant -projecthelp instead." />
  </target>

  <target name="prepare">
    <echo message="JDK ${java.version} found, make sure, it is at least 1.3." />
    <echo message="${ant.version} found, make sure it is at least 1.4." />
    <echo message="Compiler is ${build.compiler}, dependency check is ${build.depend}" />
  </target>

  <taskdef classpathref="jcoverage" resource="tasks.properties"/>

  <target name="test" depends="compile">
     <exec executable="${basedir}/../bin/runTests">
    </exec>
  </target>  

  <target name="instrument" description="Add jcoverage instrumentation" depends="compile">
   <instrument todir="${instrument.dir}">
    <fileset dir="${dist.dir}">
      <include name="**/*.class" />
      <include name="**/collection/*.class" />
      <exclude name="**/Test*.class" />
      <exclude name="**/ArrayOf*.class" />
      <exclude name="**/ListOf*.class" />
      <exclude name="**/SLListOf*.class" />
      <exclude name="**/SetOf*.class" />
      <exclude name="**/SetAsListOf*.class" />
      <exclude name="**/IteratorOf*.class" />
      <exclude name="**/MapAs*.class" />
      <exclude name="**/MapFrom*.class" />
      <exclude name="**/HashMapFrom*.class" />
      <exclude name="**/VectorOf*.class" />
      <exclude name="**/TacletForTests.class" />
     </fileset>
    </instrument>
  </target>

  <target name="coverage" depends="instrument, test">
   <mkdir dir="${instrument.dir}" />
   <report srcdir="${src.dir}" destdir="${basedir}/coverage/" />
   <delete dir="${instrument.dir}" />   
   <delete file="${basedir}/jcoverage.ser" />
  </target>

  <target name="compile" depends="keyparser, schemajava, diffparser"
          description="Compiles all java files into the source directory.">
<!--          depends="sablecc"> -->
    <javac srcdir= "${src.dir}"
           destdir="${dist.dir}"
           deprecation="on"
           debug="on"
           depend="${build.depend}"
           optimize="off">
      <include name="de/**" />
      <include name="tudresden/**" />
      <classpath>
        <pathelement location="${ext.dir}/antlr.jar" />
        <pathelement location="${ext.dir}/jargs.jar" />
        <pathelement location="${ext.dir}/recoder.jar" />
        <pathelement location="${ext.dir}/log4j.jar" />
        <pathelement location="${ext.dir}/dresden-ocl-demo.jar" />
        <pathelement location="${ext.dir}/mgtp.jar" />
        <pathelement location="${ext.dir}/javacc.jar" />
        <pathelement location="${ext.dir}/junit.jar" />
        <pathelement location="${tg.dir}/lib/openapi.jar" />
      </classpath>
    </javac>
  </target>


  <taskdef name="javacc"
           classname="org.apache.tools.ant.taskdefs.optional.javacc.JavaCC">
    <classpath>
      <pathelement location="${ant.home}/lib"/>
    </classpath>
  </taskdef>

  <target name="compile.clean">
    <delete>
      <fileset dir="${src.dir}/tudresden" includes="**/*.class" />
    </delete>
  </target>


  <target name="keylexer">
     <antlr
         target="de/uka/ilkd/key/parser/lexer.g"
         outputdirectory="${gen.dir}/de/uka/ilkd/key/parser">
        <classpath>
           <pathelement location="${ext.dir}/antlr.jar" />
        </classpath>
     </antlr>
  </target>


  <target name="diffparser">
     <javacc
         target="de/uka/ilkd/key/parser/diffparser/DiffParser.jj"
         outputdirectory="${gen.dir}/de/uka/ilkd/key/parser/diffparser"
         javacchome="${ext.dir}" />
  </target>




  <target name="keyparser"  depends="keylexer">
     <antlr
         target="de/uka/ilkd/key/parser/keyparser.g"
         outputdirectory="${gen.dir}/de/uka/ilkd/key/parser">
        <classpath>
           <pathelement location="${ext.dir}/antlr.jar" />
        </classpath>
     </antlr>
  </target>


  <target name="schemajava"> 
     <javacc
         target="de/uka/ilkd/key/parser/schemajava/SchemaJavaParser.jj"
         outputdirectory="${gen.dir}/de/uka/ilkd/key/parser/schemajava"
         javacchome="${ext.dir}" />
  </target>



  <target name="build.dir" depends="prepare">
    <mkdir dir="${build.dir}"/>
  </target>


  <!--taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask">
    <classpath>
      <pathelement location="/home/vladimir/labki/pmd-1.8/lib/pmd-1.8.jar"/>
      <pathelement location="/home/vladimir/labki/pmd-1.8/lib/jaxen-core-1.0-fcs.jar"/>
      <pathelement location="/home/vladimir/labki/pmd-1.8/lib/saxpath-1.0-fcs.jar"/>
      <pathelement location="/home/vladimir/labki/pmd-1.8/lib/xmlParserAPIs-2.0.2.jar"/>
      <pathelement location="/home/vladimir/labki/pmd-1.8/lib/xercesImpl-2.0.2.jar"/>
    </classpath>
  </taskdef> -->



<target name="pmd">
    <pmd rulesetfiles="rulesets/basic.xml,rulesets/strings.xml, rulesets/codesize.xml, rulesets/strictexception.xml">
        <formatter type="html" toFile="pmd_report.html"/>
        <fileset dir="${src.dir}">
<!--            <include name="**/*.java"/> -->
        </fileset>
    </pmd>
</target>



<!--
  <target name="docs"
          description="Builds Javadoc API documentation."
          depends="sablecc">

    <delete dir="${docs.dir}" />
    <mkdir  dir="${docs.dir}" />

    <javadoc
        sourcepath="${src.dir}"
        destdir="${docs.dir}"
        maxmemory="60m"
        private="on"
        author="on"
        windowtitle="Dresden OCL Toolkit"
        doctitle=   "Dresden OCL Toolkit"
        header=  "&lt;b&gt;Dresden OCL Toolkit&lt;/b&gt;"
        footer=  "&lt;b&gt;Dresden OCL Toolkit&lt;/b&gt;"
        splitindex="on"
        bottom='
&lt;small&gt;
&lt;a href="http://sourceforge.net/bugs/?group_id=5840" target="_top"&gt;Submit a bug&lt;/a&gt;&lt;br&gt;
Developed at the &lt;a href="http://www.inf.tu-dresden.de/welcome.html" target="_top"&gt;Dresden University of Technology&lt;/a&gt;.&lt;br&gt;
This software is published under the &lt;a href="http://www.gnu.org/copyleft/lesser.html" target="_top"&gt;GNU Lesser General Public License&lt;/a&gt;.
&lt;/small&gt;'
        >
      <link offline="on" packagelistLoc="package-list/jdk/"    href="http://java.sun.com/products/jdk/1.2/docs/api/" />
      <link offline="on" packagelistLoc="package-list/xerces/" href="http://xml.apache.org/apiDocs/"  />
      <link offline="on" packagelistLoc="package-list/junit/"  href="http://www.junit.org/junit/javadoc/" />
      <link offline="on" packagelistLoc="package-list/ant/"    href="http://jakarta.apache.org/ant/manual/api/" />

      <package name="tudresden.*" />
      <excludepackage name="tudresden.ocl.check.bootstrap" />
      <excludepackage name="tudresden.ocl.check.types.doc-files" />
      <excludepackage name="tudresden.ocl.check.types.xmifacade.stress" />
      <excludepackage name="tudresden.ocl.images" />
      <excludepackage name="tudresden.ocl.injection.reverseeng.resources.*" />
      <excludepackage name="tudresden.ocl.injection.reverseeng.test.*" />
      <excludepackage name="tudresden.ocl.lib.doc-files.*" />
      <excludepackage name="*.CVS" />

      <classpath>
        <pathelement location="${xerces.jar}" />
        <pathelement location="${junit.jar}" />
        <pathelement location="${nsuml.jar}" />
        <pathelement location="${jdom.jar}" />
        <pathelement location="${src.dir}" />
        <pathelement location="${path.jar.ant}" />
      </classpath>
    </javadoc>

  </target>

  <target name="docs.clean"
          description="Removes Javadoc API documentation.">
    <delete dir="${docs.dir}" />
  </target>

-->



</project>
